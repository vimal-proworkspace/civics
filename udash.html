<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .header { display: flex; justify-content: space-between; align-items: center; }
    .bell { position: relative; cursor: pointer; font-size: 24px; }
    .bell::after {
      content: attr(data-count);
      position: absolute;
      top: -8px; right: -8px;
      background: red; color: white;
      font-size: 12px;
      width: 18px; height: 18px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
    }
    #notificationPanel {
      display: none;
      position: absolute; top: 35px; right: 0;
      border: 1px solid #ccc; background: white;
      width: 300px; max-height: 300px; overflow-y: auto;
      padding: 10px; border-radius: 5px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      z-index: 100;
    }
    .counts { display: flex; margin-top: 20px; gap: 15px; }
    .count-card { flex: 1; padding: 15px; border: 1px solid #ccc; border-radius: 5px; text-align: center; }
    #graphContainer { margin-top: 30px; max-width: 500px; }
    button { padding: 10px 20px; margin-top: 15px; cursor: pointer; }
    .notif-item { border-bottom: 1px solid #eee; padding: 5px 0; }
  </style>
</head>
<body>
  <div class="header">
    <h2>User Dashboard</h2>
    <div style="position: relative;">
      <div class="bell" id="notificationBell" data-count="0">ðŸ””</div>
      <div id="notificationPanel"></div>
    </div>
  </div>

  <button onclick="goToReport()">Submit New Complaint</button>

  <div class="counts">
    <div class="count-card">Resolved: <span id="resolvedCount">0</span></div>
    <div class="count-card">In Progress: <span id="inProgressCount">0</span></div>
    <div class="count-card">Pending Review: <span id="pendingCount">0</span></div>
  </div>

  <div id="graphContainer">
    <canvas id="complaintChart"></canvas>
  </div>

  <h3>My Complaints</h3>
  <div id="myComplaints"></div>

  <script>
    const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
    const notifications = [];

    const resolvedEl = document.getElementById("resolvedCount");
    const inProgressEl = document.getElementById("inProgressCount");
    const pendingEl = document.getElementById("pendingCount");
    const bell = document.getElementById("notificationBell");
    const panel = document.getElementById("notificationPanel");

    function goToReport() {
      window.location.href = "user.html";
    }

    function getComplaints() {
      return JSON.parse(localStorage.getItem('complaints') || '[]');
    }

    function renderDashboard() {
      const complaints = getComplaints().filter(c => c.email === loggedInUser.email);
      let resolved = 0, inProgress = 0, pending = 0;

      panel.innerHTML = '';
      complaints.forEach(c => {
        if(c.status === "Resolved") resolved++;
        else if(c.status === "In Progress") inProgress++;
        else pending++;

        if(c.status !== "Resolved" && c.createdAt) {
          const created = new Date(c.createdAt);
          const now = new Date();
          if((now - created) / (1000*60*60) > 72) {
            notifications.push(`Your complaint "${c.title}" is pending for over 3 days.`);
          }
        }
      });

      resolvedEl.textContent = resolved;
      inProgressEl.textContent = inProgress;
      pendingEl.textContent = pending;

      bell.setAttribute('data-count', notifications.length);

      renderChart(resolved, inProgress, pending);
      renderNotifications();
      renderComplaintsList(complaints);
    }

    function renderChart(resolved, inProgress, pending) {
      const ctx = document.getElementById('complaintChart').getContext('2d');
      if(window.myChart) window.myChart.destroy();
      window.myChart = new Chart(ctx, {
        type: 'doughnut',
        data: { labels: ['Resolved', 'In Progress', 'Pending Review'], datasets:[{data:[resolved,inProgress,pending], backgroundColor:['#4caf50','#ff9800','#f44336']}] },
        options: { responsive:true }
      });
    }

    function renderNotifications() {
      panel.innerHTML = '';
      if(notifications.length === 0) panel.innerHTML = '<p>No new notifications.</p>';
      else notifications.forEach(msg => {
        const div = document.createElement('div'); div.className='notif-item'; div.textContent=msg; panel.appendChild(div);
      });
    }

    bell.addEventListener('click', () => {
      panel.style.display = panel.style.display==='block' ? 'none' : 'block';
    });

    function renderComplaintsList(list) {
      const container = document.getElementById("myComplaints");
      container.innerHTML = '';
      list.forEach(c => {
        const div = document.createElement('div');
        div.innerHTML = `
          <p><strong>${c.title}</strong></p>
          <p>${c.desc}</p>
          ${c.photo ? `<img src="${c.photo}" width="150"/>` : ""}
          <p>Category: ${c.category}</p>
          <p>Priority: ${c.priority}</p>
          <p>Location: ${c.latitude}, ${c.longitude}</p>
          <p>Status: ${c.status}</p>
          <hr/>
        `;
        container.appendChild(div);
      });
    }

    renderDashboard();
  </script>
</body>
</html>
