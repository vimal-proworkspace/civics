<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Citizen Report Submission</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f4f6f8;
    margin: 0; padding: 0;
    color: #333;
  }

  h2 {
    text-align: center;
    margin-top: 30px;
    color: #1976d2;
  }

  form {
    max-width: 600px;
    background: #fff;
    padding: 25px;
    margin: 20px auto;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    gap: 15px;
  }

  input[type="text"], textarea, select {
    width: 100%;
    padding: 10px 12px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 15px;
    box-sizing: border-box;
  }

  textarea { resize: vertical; min-height: 80px; }

  input[readonly] { background-color: #e9ecef; cursor: not-allowed; }

  label { font-weight: 600; margin-bottom: 5px; display: block; }

  button {
    background-color: #1976d2;
    color: white;
    border: none;
    padding: 12px;
    border-radius: 6px;
    font-size: 16px;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }

  button:hover { background-color: #1565c0; }

  h3 { max-width: 600px; margin: 30px auto 10px auto; color: #1976d2; }

  #myComplaints {
    max-width: 600px;
    margin: 0 auto 30px auto;
    display: flex;
    flex-direction: column;
    gap: 15px;
  }

  #myComplaints div {
    background: #fff;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    transition: transform 0.2s ease;
  }

  #myComplaints div:hover { transform: translateY(-2px); }

  #myComplaints img { max-width: 100%; border-radius: 5px; margin-top: 8px; }

  small { color: #888; font-size: 12px; }

  hr { border: none; border-top: 1px solid #eee; margin: 10px 0 0 0; }
</style>
</head>
<body>
<h2>Submit a Civic Issue</h2>
<form id="reportForm">
  <label for="title">Title</label>
  <input type="text" id="title" placeholder="Title" required />

  <label for="desc">Description</label>
  <textarea id="desc" placeholder="Description" required></textarea>

  <label for="photo">Upload Photo</label>
  <input type="file" id="photo" accept="image/*" capture="environment" required/>

  <label for="category">Category</label>
  <select id="category" required>
    <option value="">Select a category</option>
    <option value="Road & Pavement Issues">Road & Pavement Issues</option>
    <option value="Street Lighting Problems">Street Lighting Problems</option>
    <option value="Waste & Garbage Management">Waste & Garbage Management</option>
    <option value="Water Supply & Sewage">Water Supply & Sewage</option>
    <option value="Traffic Signals & Signage">Traffic Signals & Signage</option>
    <option value="Public Safety & Security">Public Safety & Security</option>
    <option value="Parks & Public Spaces">Parks & Public Spaces</option>
    <option value="Health & Sanitation">Health & Sanitation</option>
    <option value="Other / Miscellaneous">Other / Miscellaneous</option>
  </select>

  <label for="location">Location (auto-detected)</label>
  <input type="text" id="location" readonly placeholder="Fetching location..." />

  <button type="submit">Submit Report</button>
</form>

<h3>My Complaints</h3>
<div id="myComplaints"></div>

<script>
let latitude=null, longitude=null;
const geoApiKey = 'f65f46aac8b646b9bc5ed5667a619f87';

async function getAddress(lat, lon){
  try {
    const res = await fetch(`https://api.geoapify.com/v1/geocode/reverse?lat=${lat}&lon=${lon}&format=json&apiKey=${geoApiKey}`);
    const data = await res.json();
    if(data.results && data.results.length > 0) return data.results[0].formatted;
    return `${lat.toFixed(5)}, ${lon.toFixed(5)}`;
  } catch(e) { console.error(e); return `${lat.toFixed(5)}, ${lon.toFixed(5)}`; }
}

if(navigator.geolocation){
  navigator.geolocation.getCurrentPosition(async pos=>{
    latitude=pos.coords.latitude; longitude=pos.coords.longitude;
    const addr = await getAddress(latitude, longitude);
    document.getElementById('location').value = addr;
  }, ()=>{
    alert("Location required."); window.location.href='udash.html';
  });
}

const keywordMap = {
  "Road & Pavement Issues": ["pothole","road","street","sidewalk"],
  "Street Lighting Problems": ["streetlight","lamp","light","bulb"],
  "Waste & Garbage Management": ["garbage","trash","bin","litter","dumping"],
  "Water Supply & Sewage": ["water","sewage","pipeline","leakage"],
  "Traffic Signals & Signage": ["traffic","signal","sign","stop","crosswalk"],
  "Public Safety & Security": ["crime","theft","security","police"],
  "Parks & Public Spaces": ["park","garden","playground","open space"],
  "Health & Sanitation": ["health","sanitation","hospital","clinic"],
  "Other / Miscellaneous": []
};

function recommendCategory(desc){
  const text=desc.toLowerCase();
  let best="Other / Miscellaneous", max=0;
  for(const [cat,kw] of Object.entries(keywordMap)){
    let score=kw.reduce((a,k)=>a+(text.includes(k)?1:0),0);
    if(score>max){ max=score; best=cat; }
  }
  return best;
}
function assignPriority(cat){
  const high=["Road & Pavement Issues","Water Supply & Sewage","Public Safety & Security"];
  return high.includes(cat)?"High":"Normal";
}

function getComplaints(){ return JSON.parse(localStorage.getItem('complaints')||'[]'); }
function saveComplaints(arr){ localStorage.setItem('complaints', JSON.stringify(arr)); }

document.getElementById('reportForm').addEventListener('submit', async e=>{
  e.preventDefault();
  if(!latitude||!longitude){ alert("Waiting location."); return; }
  const title=document.getElementById('title').value;
  const desc=document.getElementById('desc').value;
  const selected=document.getElementById('category').value;
  const recommended=recommendCategory(desc);
  const priority=assignPriority(recommended);
  const file=document.getElementById('photo').files[0];
  let photoBase64="";

  if(!selected){ alert("Select category."); return; }
  if(selected!==recommended){
    if(!confirm(`Better fits "${recommended}". Continue with "${selected}"?`)) return;
  }

  if(file){
    photoBase64 = await new Promise(res=>{
      const reader=new FileReader();
      reader.onload=()=>res(reader.result);
      reader.readAsDataURL(file);
    });
  }

  const addr = await getAddress(latitude, longitude);

  const complaints = getComplaints();
  complaints.unshift({
    id: Date.now(), title, desc, category:selected, priority, status:"Submitted",
    latitude, longitude, address: addr, photo: photoBase64, createdAt: new Date().toISOString()
  });
  saveComplaints(complaints);
  alert("Report Submitted!"); document.getElementById('reportForm').reset();
  renderComplaints();
});

function renderComplaints(){
  const list = document.getElementById("myComplaints");
  const complaints = getComplaints();
  list.innerHTML="";
  complaints.forEach(c=>{
    const div=document.createElement("div");
    div.innerHTML=`
      <p><strong>${c.title}</strong></p>
      <p>${c.desc}</p>
      ${c.photo?`<img src="${c.photo}" width="150"/>`:''}
      <p>Category: ${c.category}</p>
      <p>Priority: ${c.priority}</p>
      <p>Location: ${c.address}</p>
      <p>Status: ${c.status}</p>
      <small>${c.createdAt}</small><hr/>
    `;
    list.appendChild(div);
  });
}
renderComplaints();
</script>
</body>
</html>
